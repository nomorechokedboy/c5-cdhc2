name: Continuous Integration
on:
    push:
        branches:
            - main
env:
    REGISTRY: ghcr.io
    IMAGE_PREFIX: ${{ github.repository_owner }}
jobs:
    detect-changes:
        runs-on: ubuntu-latest
        outputs:
            api: ${{ steps.filter.outputs.api }}
            web: ${{ steps.filter.outputs.web }}
            cron: ${{ steps.filter.outputs.cron }}
            sms-api: ${{ steps.filter.outputs.sms-api }}
            sms-web: ${{ steps.filter.outputs.sms-web }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: Check for changes
              uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      api:
                        - 'apps/api/**'
                        - 'packages/eslint-config/**'
                        - 'package.json'
                        - 'pnpm-lock.yaml'
                      web:
                        - 'apps/web/**'
                        - 'packages/eslint-config/**'
                        - 'package.json'
                        - 'pnpm-lock.yaml'
                      cron:
                        - 'deploy/cron/**'
                      sms-api:
                        - 'apps/sms-api/**'
                        - 'packages/coursegrades/**'
                        - 'packages/teachercourses/**'
                        - 'packages/userinfo/**'
                        - 'package.json'
                        - 'pnpm-lock.yaml'
                      sms-web:
                        - 'apps/sms-web/**'
                        - 'packages/ui/**'
                        - 'packages/eslint-config/**'
                        - 'package.json'
                        - 'pnpm-lock.yaml'
    build-api:
        needs: detect-changes
        if: needs.detect-changes.outputs.api == 'true'
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
            - name: Install Encore
              run: |
                  curl -L https://encore.dev/install.sh | bash
                  echo "$HOME/.encore/bin" >> $GITHUB_PATH
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
            - name: Install pnpm
              uses: pnpm/action-setup@v4
            - name: Setup pnpm store path
              id: pnpm-store
              run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
            - name: Cache pnpm store
              uses: actions/cache@v4
              with:
                  path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-
            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/qlhv-api
                  tags: |
                      type=raw,value=latest
                      type=sha,prefix={{branch}}-
            - name: Install API Dependencies
              working-directory: apps/api
              run: pnpm install --frozen-lockfile
            - name: Build Encore Docker image
              working-directory: apps/api
              run: |
                  encore build docker temp-api:build --base=node:22-slim --config ./infra.config.json
            - name: Build final Docker image
              working-directory: apps/api
              run: |
                  docker build -t temp-final-api:build .
            - name: Tag and push API image
              run: |
                  # Tag with all GHCR tags
                  for tag in $(echo "${{ steps.meta.outputs.tags }}" | tr '\n' ' '); do
                    docker tag temp-final-api:build "$tag"
                    docker push "$tag"
                  done
            - name: Image digest
              run: echo "API image pushed successfully"
    build-web:
        needs: detect-changes
        if: needs.detect-changes.outputs.web == 'true'
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/qlhv-web
                  tags: |
                      type=raw,value=latest
                      type=sha,prefix={{branch}}-
            - name: Build and push Web image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: apps/web/Dockerfile
                  cache-from: type=gha,scope=web
                  cache-to: type=gha,mode=max,scope=web
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  build-args: |
                      VITE_API_URL=${{ secrets.WEB_VITE_API_URL }}
    build-cron:
        needs: detect-changes
        if: needs.detect-changes.outputs.cron == 'true'
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/qlhv-cron
                  tags: |
                      type=raw,value=latest
                      type=sha,prefix={{branch}}-
            - name: Build and push Cron image
              uses: docker/build-push-action@v6
              with:
                  context: deploy/cron
                  cache-from: type=gha,scope=cron
                  cache-to: type=gha,mode=max,scope=cron
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
    build-sms-api:
        needs: detect-changes
        if: needs.detect-changes.outputs.sms-api == 'true'
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
            - name: Install Encore
              run: |
                  curl -L https://encore.dev/install.sh | bash
                  echo "$HOME/.encore/bin" >> $GITHUB_PATH
            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/sms-api
                  tags: |
                      type=raw,value=latest
                      type=sha,prefix={{branch}}-
            - name: Build Encore Docker image
              working-directory: apps/sms-api
              run: |
                  encore build docker temp-sms-api:build
            - name: Tag and push SMS API image
              run: |
                  # Tag with all GHCR tags
                  for tag in $(echo "${{ steps.meta.outputs.tags }}" | tr '\n' ' '); do
                    docker tag temp-sms-api:build "$tag"
                    docker push "$tag"
                  done
            - name: Image digest
              run: echo "SMS API image pushed successfully"
    build-sms-web:
        needs: detect-changes
        if: needs.detect-changes.outputs.sms-web == 'true'
        runs-on: ubuntu-latest
        strategy:
            matrix:
                env: [wan, lan] # two builds
        environment: ${{ matrix.env }}
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
            # Tag images uniquely: qlhv/sms-web:wan-latest, qlhv/sms-web:lan-latest
            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/sms-web
                  tags: |
                      type=raw,value=${{ matrix.env }}-latest
                      type=sha,prefix=${{ matrix.env }}-
            - name: Build and push SMS Web image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: apps/sms-web/Dockerfile
                  cache-from: type=gha,scope=sms-web-${{ matrix.env }}
                  cache-to: type=gha,mode=max,scope=sms-web-${{ matrix.env }}
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  build-args: |
                      VITE_CLIENT_ID=${{ secrets.VITE_CLIENT_ID }}
                      VITE_OAUTH2_URL=${{ secrets.VITE_OAUTH2_URL }}
                      VITE_TOKEN_URI=${{ secrets.VITE_TOKEN_URI }}
                      VITE_REDIRECT_URI=${{ secrets.VITE_REDIRECT_URI }}
                      VITE_API_URL=${{ secrets.VITE_API_URL }}
