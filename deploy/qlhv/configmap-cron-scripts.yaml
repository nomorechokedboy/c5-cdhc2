apiVersion: v1
kind: ConfigMap
metadata:
  name: qlhv-cron-scripts
  labels:
    app: qlhv-cronjobs
data:
  weekly_birthday.sh: |
    #!/bin/sh
    # File: ./cron/scripts/weekly_birthday.sh
    # Weekly birthday notification script

    set -e

    APP_URL="${APP_URL:-http://app:8080}"
    ENDPOINT="/students/cron?event=birthdayThisWeek"
    TIMEOUT=30
    MAX_RETRIES=3

    log() {
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
    }

    check_app_health() {
        local retries=0
        while [ $retries -lt $MAX_RETRIES ]; do
            if wget --spider --timeout=$TIMEOUT "${APP_URL}/healthz" > /dev/null 2>&1; then
                return 0
            fi
            retries=$((retries + 1))
            log "Health check failed, retry $retries/$MAX_RETRIES"
            sleep 5
        done
        return 1
    }

    main() {
        log "Starting weekly birthday notification job"
        
        if ! check_app_health; then
            log "ERROR: App health check failed after $MAX_RETRIES attempts"
            exit 1
        fi
        
        log "Calling endpoint: ${APP_URL}${ENDPOINT}"
        
        if wget --timeout=$TIMEOUT -O- -q "${APP_URL}${ENDPOINT}"; then
            log "SUCCESS: Weekly birthday notification completed"
        else
            log "ERROR: Weekly birthday notification failed"
            exit 1
        fi
    }

    main "$@"

  monthly_birthday.sh: |
    #!/bin/sh
    # File: ./cron/scripts/monthly_birthday.sh
    # Monthly birthday notification script

    set -e

    APP_URL="${APP_URL:-http://app:8080}"
    ENDPOINT="/students/cron?event=birthdayThisMonth"
    TIMEOUT=30
    MAX_RETRIES=3

    log() {
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
    }

    check_app_health() {
        local retries=0
        while [ $retries -lt $MAX_RETRIES ]; do
            if wget --spider --timeout=$TIMEOUT "${APP_URL}/healthz" > /dev/null 2>&1; then
                return 0
            fi
            retries=$((retries + 1))
            log "Health check failed, retry $retries/$MAX_RETRIES"
            sleep 5
        done
        return 1
    }

    main() {
        log "Starting monthly birthday notification job"
        
        if ! check_app_health; then
            log "ERROR: App health check failed after $MAX_RETRIES attempts"
            exit 1
        fi
        
        log "Calling endpoint: ${APP_URL}${ENDPOINT}"
        
        if wget --timeout=$TIMEOUT -O- -q "${APP_URL}${ENDPOINT}"; then
            log "SUCCESS: Monthly birthday notification completed"
        else
            log "ERROR: Monthly birthday notification failed"
            exit 1
        fi
    }

    main "$@"

  quarterly_birthday.sh: |
    #!/bin/sh
    # File: ./cron/scripts/quarterly_birthday.sh
    # Quarterly birthday notification script

    set -e

    APP_URL="${APP_URL:-http://app:8080}"
    ENDPOINT="/students/cron?event=birthdayThisQuarter"
    TIMEOUT=30
    MAX_RETRIES=3

    log() {
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
    }

    check_app_health() {
        local retries=0
        while [ $retries -lt $MAX_RETRIES ]; do
            if wget --spider --timeout=$TIMEOUT "${APP_URL}/healthz" > /dev/null 2>&1; then
                return 0
            fi
            retries=$((retries + 1))
            log "Health check failed, retry $retries/$MAX_RETRIES"
            sleep 5
        done
        return 1
    }

    main() {
        log "Starting quarterly birthday notification job"
        
        if ! check_app_health; then
            log "ERROR: App health check failed after $MAX_RETRIES attempts"
            exit 1
        fi
        
        log "Calling endpoint: ${APP_URL}${ENDPOINT}"
        
        if wget --timeout=$TIMEOUT -O- -q "${APP_URL}${ENDPOINT}"; then
            log "SUCCESS: Quarterly birthday notification completed"
        else
            log "ERROR: Quarterly birthday notification failed"
            exit 1
        fi
    }

    main "$@"

  weekly_cpv_official.sh: |
    #!/bin/sh
    # File: ./cron/scripts/weekly_cpv_official.sh
    # Weekly cpv_official notification script

    set -e

    APP_URL="${APP_URL:-http://app:8080}"
    ENDPOINT="/students/cron?event=cpvOfficialThisWeek"
    TIMEOUT=30
    MAX_RETRIES=3

    log() {
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
    }

    check_app_health() {
        local retries=0
        while [ $retries -lt $MAX_RETRIES ]; do
            if wget --spider --timeout=$TIMEOUT "${APP_URL}/healthz" > /dev/null 2>&1; then
                return 0
            fi
            retries=$((retries + 1))
            log "Health check failed, retry $retries/$MAX_RETRIES"
            sleep 5
        done
        return 1
    }

    main() {
        log "Starting weekly cpv official notification job"
        
        if ! check_app_health; then
            log "ERROR: App health check failed after $MAX_RETRIES attempts"
            exit 1
        fi
        
        log "Calling endpoint: ${APP_URL}${ENDPOINT}"
        
        if wget --timeout=$TIMEOUT -O- -q "${APP_URL}${ENDPOINT}"; then
            log "SUCCESS: Weekly cpv official notification completed"
        else
            log "ERROR: Weekly cpv official notification failed"
            exit 1
        fi
    }

    main "$@"

  monthly_cpv_official.sh: |
    #!/bin/sh
    # File: ./cron/scripts/monthly_cpv_official.sh
    # Monthly cpv official notification script

    set -e

    APP_URL="${APP_URL:-http://app:8080}"
    ENDPOINT="/students/cron?event=cpvOfficialThisMonth"
    TIMEOUT=30
    MAX_RETRIES=3

    log() {
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
    }

    check_app_health() {
        local retries=0
        while [ $retries -lt $MAX_RETRIES ]; do
            if wget --spider --timeout=$TIMEOUT "${APP_URL}/healthz" > /dev/null 2>&1; then
                return 0
            fi
            retries=$((retries + 1))
            log "Health check failed, retry $retries/$MAX_RETRIES"
            sleep 5
        done
        return 1
    }

    main() {
        log "Starting monthly cpv official notification job"
        
        if ! check_app_health; then
            log "ERROR: App health check failed after $MAX_RETRIES attempts"
            exit 1
        fi
        
        log "Calling endpoint: ${APP_URL}${ENDPOINT}"
        
        if wget --timeout=$TIMEOUT -O- -q "${APP_URL}${ENDPOINT}"; then
            log "SUCCESS: Monthly cpv official notification completed"
        else
            log "ERROR: Monthly cpv official notification failed"
            exit 1
        fi
    }

    main "$@"

  quarterly_cpv_official.sh: |
    #!/bin/sh
    # File: ./cron/scripts/quarterly_cpv_official.sh
    # Quarterly cpv official notification script

    set -e

    APP_URL="${APP_URL:-http://app:8080}"
    ENDPOINT="/students/cron?event=cpvOfficialThisQuarter"
    TIMEOUT=30
    MAX_RETRIES=3

    log() {
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
    }

    check_app_health() {
        local retries=0
        while [ $retries -lt $MAX_RETRIES ]; do
            if wget --spider --timeout=$TIMEOUT "${APP_URL}/healthz" > /dev/null 2>&1; then
                return 0
            fi
            retries=$((retries + 1))
            log "Health check failed, retry $retries/$MAX_RETRIES"
            sleep 5
        done
        return 1
    }

    main() {
        log "Starting quarterly cpv official notification job"
        
        if ! check_app_health; then
            log "ERROR: App health check failed after $MAX_RETRIES attempts"
            exit 1
        fi
        
        log "Calling endpoint: ${APP_URL}${ENDPOINT}"
        
        if wget --timeout=$TIMEOUT -O- -q "${APP_URL}${ENDPOINT}"; then
            log "SUCCESS: Quarterly cpv official notification completed"
        else
            log "ERROR: Quarterly cpv official notification failed"
            exit 1
        fi
    }

    main "$@"
